{"ts":1378039941392,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n/**\n * ownCloud setup wizard\n *\n * @author Frank Karlitschek\n * @copyright 2012 Frank Karlitschek frank@owncloud.org\n *\n * This library is free software; you can redistribute it and/or\n * modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE\n * License as published by the Free Software Foundation; either\n * version 3 of the License, or any later version.\n *\n * This library is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU AFFERO GENERAL PUBLIC LICENSE for more details.\n *\n * You should have received a copy of the GNU Affero General Public\n * License along with this library.  If not, see <http://www.gnu.org/licenses/>.\n *\n */\n\n/**\n * Please copy this file into your webserver root and open it with a browser. The setup wizard checks the dependency, downloads the newest ownCloud version, unpacks it and redirects to the ownCloud first run wizard.\n */\n\n\n// init\nob_start(); \nerror_reporting(E_ERROR | E_WARNING | E_PARSE | E_NOTICE);\nini_set('display_errors', 1);\n@set_time_limit(0);\n \n/**\n * @brief Setup class with a few helper functions\n *\n */ \nclass oc_setup {\n\n \n\t/**\n\t* @brief Checks if all the ownCloud dependencies are installed\n\t* @return string with error messages\n\t*/ \n\tstatic public function checkdependencies() {\n\t\t$error='';\n\t\t\n\t\t// do we have PHP 5.3.2 or newer?\n                if(version_compare(PHP_VERSION, '5.3.2', '<')) {\n\t\t\t$error.='PHP 5.3.2 is required. Please ask your server administrator to update PHP to version 5.3.2 or higher. PHP 5.2 is no longer supported by ownCloud and the PHP community.';\n\t\t}\n\t\t\n\t\t// do we have the zip module?\n\t\tif(!class_exists('ZipArchive')){\n\t\t\t$error.='PHP module zip not installed. Please ask your server administrator to install the module.';\n\t\t}\n\n\t\t// do we have the curl module?\n\t\tif(!function_exists('curl_exec')){\n\t\t\t$error.='PHP module curl not installed. Please ask your server administrator to install the module.';\n\t\t}\n\t\t\n\t\t// do we have write permission?\n\t\tif(!is_writable('.')) {\n\t\t\t$error.='Can\\'t write to the current directory. Please fix this by giving the webserver user write access to the directory.';\n\t\t}\n\n\t\t// is safe_mode enabled?\n\t\tif(ini_get('safe_mode')) {\n\t\t\t$error.='PHP Safe Mode is enabled. ownCloud requires that it is disabled to work properly.';\n\t\t}\n\t\t\n\t\treturn($error);\n\t}\n\n\n\t/**\n\t* @brief Check the cURL version\n\t* @return bool status of CURLOPT_CERTINFO implementation\n\t*/ \n\tstatic public function iscertinfoavailable(){\n\t\t$curlDetails =  curl_version();\n\t\treturn version_compare($curlDetails['version'], '7.19.1') != -1;\n\t}\n\n\n \n\t/**\n\t* @brief Performs the ownCloud install. \n\t* @return string with error messages\n\t*/ \n\tstatic public function install() {\t\n\t\t$error='';\n\t\t\n\t\t// downloading latest release\n\t\t$error.=oc_setup::getfile('https://download.owncloud.org/download/community/owncloud-latest.zip','oc.zip');\n\t\t\n\t\t// unpacking into owncloud folder\n\t\t$zip = new ZipArchive;\n\t\t$res = $zip->open('oc.zip');\n\t\tif ($res==true) {\n\t\t\t// Extract it to the tmp dir\n\t\t\t$owncloud_tmp_dir = 'tmp-owncloud'.time();\n\t\t\t$zip->extractTo($owncloud_tmp_dir);\n\t\t\t$zip->close();\n\n\t\t\t// Move it to the folder\n\t\t\trename($owncloud_tmp_dir.'/owncloud', \"./\".$_GET['directory']);\n\t\t\t// Delete the tmp folder\n\t\t\trmdir($owncloud_tmp_dir);\n\t\t} else {\n\t\t\t$error.='unzip of owncloud source file failed.<br />';\n\t\t}\n\n\t\t// deleting zip file\n\t\t$result=@unlink('oc.zip');\n\t\tif($result==false) $error.='deleting of oc.zip failed.<br />';\n\t\treturn($error);\n\t}\n\n\t \n\t/**\n\t* @brief Downloads a file and stores it in the local filesystem\n\t* @param url $url\n\t* @param path $path\t\n\t* @return string with error messages\n\t*/ \n\tstatic public function getfile($url,$path) {\n\t\t$error='';\n\n\t\t$fp = fopen ($path, 'w+');\n\t\t$ch = curl_init($url); \n\t\tcurl_setopt($ch, CURLOPT_TIMEOUT, 0);\n\t\tcurl_setopt($ch, CURLOPT_FILE, $fp); \n\t\tcurl_setopt($ch, CURLOPT_USERAGENT, $_SERVER['HTTP_USER_AGENT']);\n\t\tif (oc_setup::iscertinfoavailable()){\n\t\t\tcurl_setopt($ch, CURLOPT_CERTINFO, TRUE); \n\t\t}\n\t\tcurl_setopt($ch, CURLOPT_SSL_VERIFYPEER, TRUE); \n\t\t$data=curl_exec($ch);\n\t\t$curlerror=curl_error($ch);\n\t\tcurl_close($ch);\n\t\tfclose($fp);\n \n\t\tif($data==false){\n\t\t\t$error.='download of ownCloud source file failed.<br />'.$curlerror;\t\n\t\t}\n\t\treturn($error.$curlerror);\n\n\t}\n \n  \n\t/**\n\t* @brief Shows the html header of the setup page\n\t*/ \n\tstatic public function showheader(){\n\t\techo('\n\t\t<!DOCTYPE html>\n\t\t<html>\t\n\t\t\t<head>\t\n\t\t\t\t<title>ownCloud Setup</title>\n\t\t\t\t<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\n\t\t\t\t<link rel=\"icon\" type=\"image/png\" href=\"http://owncloud.org/setupwizard/favicon.png\" />\n\t\t\t\t<link rel=\"stylesheet\" href=\"http://owncloud.org/setupwizard/styles.css\" type=\"text/css\" media=\"screen\" />\n\t\t\t</head>\n\n\t\t\t<body id=\"body-login\">\n\t\t');\n\t}\n\n \n\t/**\n\t* @brief Shows the html footer of the setup page\n\t*/ \n\tstatic public function showfooter(){\n\t\techo('\n\t\t<footer><p class=\"info\"><a href=\"http://owncloud.org/\">ownCloud</a> &ndash; web services under your control</p></footer>\n\t\t</body>\n\t\t</html>\t\n\t\t');\n\t}\n\t\n\t \n\t/**\n\t* @brief Shows the html content part of the setup page\n\t* @param title $title\t\n\t* @param content $content\n\t* @param nextpage $nextpage\n\t*/ \n\tstatic public function showcontent($title,$content,$nextpage=''){\n\t\techo('\n\t\t<div id=\"login\">\n\t\t\t<header><div id=\"header\">\n\t\t\t\t<img src=\"http://owncloud.org/setupwizard/logo.png\" alt=\"ownCloud\" />\n\t\t\t</div></header><br />\n\t\t\t<p style=\"text-align:center; font-size:28px; color:#444; font-weight:bold;\">'.$title.'</p><br />\n\t\t\t<p style=\"text-align:center; font-size:13px; color:#666; font-weight:bold; \">'.$content.'</p>\n\t\t\t<form method=\"get\">\n\t\t\t\t<input type=\"hidden\" name=\"step\" value=\"'.$nextpage.'\" />\n\t\t');\n\n\t\tif($nextpage === 2) {\n\t\t\techo ('Install in subdirectory: <input type=\"text\" name=\"directory\" value=\"owncloud\" required=\"required\"/>');\n\t\t}\n\t\tif($nextpage === 3) {\n\t\t\techo ('<input type=\"hidden\" value=\"'.$_GET['directory'].'\" name=\"directory\" />');\n\t\t}\n\n\t\tif($nextpage<>'') echo('<input type=\"submit\" id=\"submit\" class=\"login\" style=\"margin-right:100px;\" value=\"Next\" />');\n\n\t\techo('\n\t\t</form>\n\t\t</div>\n\t\t\n\t\t');\n\t}\n\n\n\t/**\n\t* @brief Shows the wecome screen of the setup wizard\n\t*/ \n\tstatic public function showwelcome(){\n\t\t$txt='Welcome to the ownCloud Setup Wizard.<br />This wizard will check the ownCloud dependencies, download the newest version of ownCloud and install it in a few simple steps.';\n\t\toc_setup::showcontent('Setup Wizard',$txt,1);\n\t}\n\n\n\t/**\n\t* @brief Shows the check dependencies screen\n\t*/ \n\tstatic public function showcheckdependencies(){\n\t\t$error=oc_setup::checkdependencies();\n\t\tif($error=='') {\n\t\t\t$txt='All ownCloud dependencies found';\n\t\t\toc_setup::showcontent('Dependency check',$txt,2);\n\t\t}else{\n\t\t\t$txt='Dependencies not found.<br />'.$error;\n\t\t\toc_setup::showcontent('Dependency check',$txt);\n\t\t}\n\t}\n\n\n\t/**\n\t* @brief Shows the install screen\n\t*/ \n\tstatic public function showinstall(){\n\t\t$error=oc_setup::install();\n\t\n\t\tif($error=='') {\n\t\t\t$txt='ownCloud is now installed';\n\t\t\toc_setup::showcontent('Success',$txt,3);\n\t\t}else{\n\t\t\t$txt='ownCloud is NOT installed<br />'.$error;\n\t\t\toc_setup::showcontent('Error',$txt);\n\t\t}\n\t}\n\n\n\t/**\n\t* @brief Shows the redirect screen\n\t*/ \n\tstatic public function showredirect(){\n\t\t// delete own file\n\t\t@unlink($_SERVER['SCRIPT_FILENAME']);\n\t\t\n\t\t// redirect to ownCloud\n\t\theader(\"Location: \".$_GET['directory']);\t\n\t}\n\t\n}\n\n\n// read the step get variable\nif(isset($_GET['step'])) $step=$_GET['step']; else $step=0;\n\n// show the header\noc_setup::showheader();\n\n// show the right step\nif     ($step==0) oc_setup::showwelcome();\nelseif ($step==1) oc_setup::showcheckdependencies();\nelseif ($step==2) oc_setup::showinstall();\nelseif ($step==3) oc_setup::showredirect();\nelse  echo('Internal error. Please try again.'); \n\n// show the footer\noc_setup::showfooter();\n\n\n?>\n"]],"start1":0,"start2":0,"length1":0,"length2":7928}]],"length":7928}
